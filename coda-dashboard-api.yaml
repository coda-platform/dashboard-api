apiVersion: v1
kind: Template
metadata:
  creationTimestamp: null
  name: coda-dashboard-api
  annotations:
    openshift.io/display-name: coda-dashboard-api
    description: Coda node purple api (hub)
    iconClass: icon-nodejs
    tags: coda
objects:
- apiVersion: v1
  kind: Secret
  metadata:
    name: ${CODA_HUB_DASH_BACK}-kc-identifiers
    labels:
      application: ${CODA_HUB_DASH_BACK}
  type: Opaque
  stringData:
    secret: ${CODA_DASHBOARD_API_KEYCLOAK_CLIENT_SECRET}
- apiVersion: v1
  kind: Secret
  metadata:
    name: ${CODA_HUB_DASH_BACK}-kc-sessions
    labels:
      application: ${CODA_HUB_DASH_BACK}
  type: Opaque
  stringData:
    secret: ${CODA_DASHBOARD_API_KEYCLOAK_SESSION_MEMORY_SECRET}
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      openshift.io/generated-by: OpenShiftWebConsole
    creationTimestamp: null
    labels:
      app: ${CODA_HUB_DASH_BACK}
    name: ${CODA_HUB_DASH_BACK}
  spec:
    ports:
    - name: 8080-tcp
      port: 8080
      protocol: TCP
      targetPort: 3000
    selector:
      deploymentconfig: ${CODA_HUB_DASH_BACK}
    sessionAffinity: None
    type: ClusterIP
- apiVersion: v1
  kind: Route
  metadata:
    labels:
      app: ${CODA_HUB_DASH_BACK}
    annotations:
      description: Route pour coda-hub-api
      haproxy.router.openshift.io/timeout: 90s
    name: ${CODA_HUB_DASH_BACK}
  spec:
    host: '${CODA_HUB_DASH_BACK_FQDN}'
    port:
      targetPort: 8080-tcp
    tls:
      termination: edge
    to:
      kind: Service
      name: ${CODA_HUB_DASH_BACK}
      weight: 100
    wildcardPolicy: None
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    annotations:
      openshift.io/generated-by: OpenShiftWebConsole
    labels:
      app: ${CODA_HUB_DASH_BACK}
    name: ${CODA_HUB_DASH_BACK}
  spec:
    replicas: 1
    selector:
      app: ${CODA_HUB_DASH_BACK}
      deploymentconfig: ${CODA_HUB_DASH_BACK}
    strategy:
      type: Rolling
    template:
      metadata:
        labels:
          app: ${CODA_HUB_DASH_BACK}
          deploymentconfig: ${CODA_HUB_DASH_BACK}
      spec:
        containers:
          - env:
            - name: CODA_DASHBOARD_API_HUB_ENDPOINT
              value: '${CODA_DASHBOARD_API_HUB_ENDPOINT}'
            - name: CODA_DASHBOARD_API_KEYCLOAK_URL
              value: '${CODA_DASHBOARD_API_KEYCLOAK_URL}'
            - name: CODA_DASHBOARD_API_KEYCLOAK_REALM
              value: '${CODA_DASHBOARD_API_KEYCLOAK_REALM}'
            - name: CODA_DASHBOARD_API_KEYCLOAK_CLIENT_SECRET
              valueFrom:
                    secretKeyRef:
                      key: secret
                      name: ${CODA_HUB_DASH_BACK}-kc-identifiers
            - name: CODA_DASHBOARD_API_KEYCLOAK_SESSION_MEMORY_SECRET
              valueFrom:
                    secretKeyRef:
                      key: secret
                      name: ${CODA_HUB_DASH_BACK}-kc-sessions
            name: ${CODA_HUB_DASH_BACK}
            image: coda/coda-hub-dashboard-back:latest
            ports:
              - name: ${CODA_HUB_DASH_BACK}
                containerPort: 8080
            securityContext:
                runAsUser: 1000
        serviceAccount: coda-builder
        serviceAccountName: coda-builder
    triggers:
    - type: ConfigChange
parameters:
- displayName: Nom des objects OpenShift
  name: CODA_HUB_DASH_BACK
  value: coda-hub-back
  required: true
- name: CODA_HUB_DASH_BACK_FQDN
  displayName: Custom https Route Hostname
  description: >-
    Custom hostname for https service route. Leave blank for default hostname,
    e.g.: <application-name>-<namespace>.<default-domain-suffix>
  value: dashboard-api.hub.coda.com
- name: CODA_DASHBOARD_API_HUB_ENDPOINT
  displayName: HUB ENDPOINT
  description: 'Hub Endpoint'
  required: true
- name: CODA_DASHBOARD_API_KEYCLOAK_URL
  displayName: KEYCLOAK URL
  description: 'Keycloak Url'
  required: true
- name: CODA_DASHBOARD_API_KEYCLOAK_REALM
  displayName: KEYCLOAK REALM
  description: 'Keycloak Realm'
  required: true
- name: CODA_DASHBOARD_API_KEYCLOAK_CLIENT_SECRET
  displayName: KEYCLOAK CLIENT SECRET
  description: 'Keycloak client secret'
  required: true
- name: CODA_DASHBOARD_API_KEYCLOAK_SESSION_MEMORY_SECRET
  displayName: KEYCLOAK SESSION MEMORY SECRET
  description: 'Keycloak session memory secret'
  required: true
